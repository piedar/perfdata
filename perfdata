#!/bin/bash
# SPDX-License-Identifier: AGPL-3.0-only

function debug() {
	echo >&2 "${0}: ${@}"
}

(return 0 2>/dev/null) && debug "this script cannot be sourced" && return 1

set -e

function die() {
	debug "${@}"
	exit 1
}

function hashsum() {
	sha256sum "${@}" | awk '{ print $1 }'
}

SCRIPT_DIR="$(dirname "$(realpath "${BASH_SOURCE[@]})")")"


COMMAND="${1:?COMMAND not specified}"

EXE_PATH="$(type -p "${COMMAND}" || true)"
if [ -z "${EXE_PATH}" ]; then
	debug "COMMAND ${COMMAND} has no executable path (is it a shell builtin?)"
	exec "${@}"
fi

if [ -z "${PERFDATA_PROFILE_DIR}" ]; then
	EXE_NAME="$(basename "$(realpath "${EXE_PATH}")")"
	: "${PERFDATA_DIR:=${XDG_CACHE_HOME:-${HOME:?}/.cache}/perfdata}"
	: "${PERFDATA_PROFILE:=${EXE_NAME}}"
	PERFDATA_PROFILE_DIR="${PERFDATA_DIR}/${PERFDATA_PROFILE}"
fi
mkdir -p "${PERFDATA_PROFILE_DIR}"

: "${PERFDATA_STAMP:=$(hashsum "${EXE_PATH}")}"
PERFDATA_OUTPUT="${PERFDATA_PROFILE_DIR}/${PERFDATA_STAMP}-$(date --utc +'%s')-$$.perfdata"
#debug "saving perfdata to ${PERFDATA_OUTPUT}"

PERFDATA_PROFILE_DIR="${PERFDATA_PROFILE_DIR}" "${SCRIPT_DIR}/perfdata-cleanup"

# compression levels >= 10 cause lost samples on my system
# compression has diminishing returns after about level 8

perf record --freq=max --branch-filter 'any,u' --mmap-flush=100K \
	--compression-level=8 --output "${PERFDATA_OUTPUT}" -- "${@}"

# the output of llvm-profgen is tiny by comparison
# do the conversion now if so configured
# todo: disown or otherwise daemonize this part
if "${PERFDATA_CONVERT_PROF:-false}"; then
	PROF_OUTPUT="${PERFDATA_OUTPUT}.prof"
	if [ ! -f "${PROF_OUTPUT}" ]; then
		"${SCRIPT_DIR}/perf2prof" "${PERFDATA_OUTPUT}" --binary "${EXE_PATH}" --output "${PROF_OUTPUT}"
		chmod 0440 "${PROF_OUTPUT}"
	fi
	rm "${PERFDATA_OUTPUT}"
else
	chmod 0440 "${PERFDATA_OUTPUT}"
fi
